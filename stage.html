<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>1.62.1 stage.html - 起動儀式と実戦シーケンスの完全実装</title>
    <style>
        :root { --g-blue: #4285F4; --g-red: #EA4335; --g-yellow: #FBBC05; --g-green: #34A853; --card-w: 105px; --card-h: 215px; }
        html, body { overflow: hidden; height: 100%; width: 100%; background: #202124; margin: 0; display: flex; font-family: sans-serif; }
        #iphone-frame { width: 375px; height: 812px; background: #fff; position: relative; border-radius: 40px; border: 8px solid #444; overflow: hidden; display: flex; flex-direction: column; }
        .area-jiji { flex: 200; background: var(--g-blue); position: relative; }
        .area-mid { flex: 280; background: #fff; position: relative; }
        .area-kaito { flex: 332; background: var(--g-yellow); position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; }
        .card-base { width: var(--card-w); height: var(--card-h); background: white; border: 4px solid var(--g-yellow); border-radius: 12px; position: absolute; transition: all 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl; font-size: 1.8rem; font-weight: 900; }
        .tri-red-top { position: absolute; top: 0; border-left: 35px solid transparent; border-right: 35px solid transparent; border-top: 20px solid var(--g-red); }
        .tri-red-btm { position: absolute; bottom: 0; border-left: 35px solid transparent; border-right: 35px solid transparent; border-bottom: 20px solid var(--g-red); }
        .tri-grn-left { position: absolute; left: 0; border-top: 50px solid transparent; border-bottom: 50px solid transparent; border-left: 10px solid var(--g-green); }
        .tri-grn-right { position: absolute; right: 0; border-top: 50px solid transparent; border-bottom: 50px solid transparent; border-right: 10px solid var(--g-green); }
        .icon-circle { width: 70px; height: 70px; border-radius: 50%; background: white; border: 2px solid #ccc; position: absolute; z-index: 100; }
        #debug-panel { flex: 1; color: #0f0; font-family: monospace; font-size: 10px; background: #000; padding: 10px; overflow-y: auto; }
        .log-line { border-bottom: 1px solid #222; margin-bottom: 2px; }
        #retry-btn { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); padding:20px; background:var(--g-red); color:white; border-radius:50%; cursor:pointer; z-index:200; }
    </style>
</head>
<body>
    <div id="iphone-frame">
        <div class="area-jiji"><div class="icon-circle" style="top:10px; left:50%; transform:translateX(-50%);"></div></div>
        <div class="area-mid" id="mid-area"><div id="retry-btn" onclick="location.reload()">もう一回</div></div>
        <div class="area-kaito" id="kaito-area"><div id="kaito-icon" class="icon-circle" style="bottom:10px; right:10px; display:none;"></div></div>
    </div>
    <div id="debug-panel"><div id="fmt-log"></div></div>

<script>
const wordSource = ["りんご","ごりら","らっぱ","ぱせり","りす","すいか","かめ","めだか","からす","すべりだい","いか","かさ","さかな","なす","すぽーつ","つくえ","えりまき","きつね","ねこ","こあら","らくがき","きゃあ","あひる","るびー","いぬ","ぬいぐるみ","みみ","みず","すなば","はとり"];
let mainMaster = wordSource.map((w, i) => ({ flagA: (i===0?1:0), flagB: 0, no: i + 1, head: w[0], tail: w.slice(-1), word: w }));
let workData = [];
let lastTail = "り";

function msgFmt(to, from, type, detail) {
    const line = document.createElement('div');
    line.className = 'log-line';
    line.innerText = `msgFmt: [${to}] from [${from}] - ${type} | ${detail}`;
    document.getElementById('fmt-log').prepend(line);
}

const mainMasterObj = {
    handleRequest(from, detail) {
        msgFmt("mainMaster", from, "依頼", detail);
        if (detail === "起動直後処理") {
            workData = JSON.parse(JSON.stringify(mainMaster));
            workData.sort((a, b) => (b.flagA - a.flagA) || (a.no - b.no));
            msgFmt("workFiles", "mainMaster", "処理", "workData生成");
            setTimeout(() => msgFmt("jijiHand", "mainMaster", "正常完了", "起動直後処理"), 500);
            setTimeout(() => jijiHand.init(), 600);
        }
    },
    updateFlag(no) {
        const target = mainMaster.find(m => m.no === no);
        if (target) target.flagB = 1;
        msgFmt("gameStage", "mainMaster", "完了", "flagB更新完了");
    }
};

const workFiles = {
    pick(who, detail) {
        msgFmt("workFiles", who, "要求起動直後処理", detail);
        let results = [];
        if (who === "jijiHand") {
            results.push({type: "正解", data: workData[0]});
            results.push({type: "不正解", data: workData[workData.length-1]});
            results.push({type: "不正解", data: workData[workData.length-2]});
        } else {
            results.push({type: "正解", data: workData[1]});
            results.push({type: "不正解", data: workData[workData.length-3]});
            results.push({type: "不正解", data: workData[workData.length-4]});
        }
        results.forEach(r => {
            const dataStr = `${r.data.flagA},${r.data.flagB},${r.data.no},${r.data.head},${r.data.tail},${r.data.word}`;
            msgFmt(who, "workFiles", r.type, `${detail}, ${dataStr}`);
        });
        return results;
    },
    removeAndSort(no) {
        workData = workData.filter(d => d.no !== no);
        workData.sort((a, b) => a.tail.localeCompare(b.tail) || a.no - b.no);
        msgFmt("gameStage", "workFiles", "完了", "削除・ソート完了");
    }
};

const jijiHand = {
    cards: [],
    init() {
        this.cards = workFiles.pick("jijiHand", "正解1, 不正解2");
        setTimeout(() => {
            msgFmt("kaitoHand", "jijiHand", "伝える", "起動直後処理");
            kaitoHand.init();
        }, 500);
        setTimeout(() => this.play(0), 1500); // りんご
    },
    play(idx) {
        const c = this.cards[idx];
        const dataStr = `${c.data.no}, ${c.data.flagA}, ${c.data.flagB}, ${c.data.no}, "${c.data.head}", "${c.data.tail}", "${c.data.word}"`;
        msgFmt("gameStage", "jijiHand", "正解", dataStr);
        gameStage.receive(c.data, "jiji");
        this.cards.splice(idx, 1);
    },
    discardRest() {
        // 演出：左外へ
        msgFmt("System", "jijiHand", "演出", "残り手札クリア(左外へ)");
        this.cards = [];
    }
};

const kaitoHand = {
    cards: [],
    init() {
        this.cards = workFiles.pick("kaitoHand", "正解1, 不正解2");
        document.getElementById('kaito-icon').style.display = 'block';
    },
    play(idx, type) {
        const c = this.cards[idx];
        const dataStr = `${c.data.no}, ${c.data.flagA}, ${c.data.flagB}, ${c.data.no}, "${c.data.head}", "${c.data.tail}", "${c.data.word}"`;
        msgFmt("gameStage", "kaitoHand", type, dataStr);
        gameStage.receive(c.data, "kaito", type);
        this.cards.splice(idx, 1);
    }
};

const gameStage = {
    receive(data, from, type = "正解") {
        lastTail = data.tail;
        workFiles.removeAndSort(data.no);
        mainMasterObj.updateFlag(data.no);

        if (from === "jiji" && data.word === "りんご") {
            setTimeout(() => kaitoHand.play(0, "正解"), 1000); // ごりら
        } else if (from === "kaito" && data.word === "ごりら") {
            jijiHand.discardRest();
            setTimeout(() => {
                jijiHand.cards = workFiles.pick("jijiHand", "正解1, 不正解2");
                setTimeout(() => jijiHand.play(0), 1000); // らっぱ
            }, 800);
        } else if (from === "jiji" && data.word === "らっぱ") {
            setTimeout(() => kaitoHand.play(1, "不正解"), 1000); // はとり
        } else if (type === "不正解") {
            document.getElementById('retry-btn').style.display = 'block';
            msgFmt("System", "User", "表示", "もう一回ボタン");
        }
    }
};

window.onload = () => {
    msgFmt("System", "User", "Start", "バレリーナ待機(2s)");
    setTimeout(() => mainMasterObj.handleRequest("jijiHand", "起動直後処理"), 2000);
};
</script>
</body>
</html>
